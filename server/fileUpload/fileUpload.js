const uuid = require("uuid");
const fs = require("fs");

const get_extension = encoded => {
  if (encoded[0] == "/") {
    return "jpg";
  } else if (encoded[0] == "i") {
    return "png";
  } else if (encoded[0] == "R") {
    return "gif";
  } else if (encoded[0] == "U") {
    return "webp";
  }
};

const processUpload = async (
  upload,
  mimetype,
  context,
  save_encoding = false
) => {
  if (!upload) {
    return processUpload(
      "iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAMAAADDpiTIAAAAflBMVEXyx0T789fzyk70zVn1027zzVn34Jj9+ez22YP89uL67cL55q3889f78M344Jjzyk/21nj546L22oP00GT0027446P67ML556333I356bf56rf23Y3778366bf33Y733Y323Y733I7213j446L546P45q321nn00GP11nnz0GR95PMtAAAMnklEQVR42u3d53bbSBKG4QIJIhIUc5JlyRo5zP3f4NJxd3ZsRgCs8H7/fY4P6mF3VTdISU5CR3gEACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIHEBJE212WRZ8StZNttUTQkA95XfzIp0KH/MMC2yfQMAhymrWXGk8v/MYjqrSgD4Kf5+u5CLk273JQDsp9qmcnUW2woAlj/6m2IgN2ZQ1CUAbFY/vbn6PzKtAWBv5W+r+j/WgQoAhj78k6G0nlGdAMDGh78YSDcpGgDoL38qHSatAaA6dafl/74TAEBv+YfSQ3wRcASg6qX83gi4AVCl0mNGDQBUZfxJek6RAEDR3D+Q/jMBQLjN///2gScAaPj4v5e7xcE+YB7AbiB3jP15QPj4x14EbAO41+7/j0XgHQDulZmoyAQA95n9U1GSNAFA/2mGoiaGtwGzAGaiKm8A6DfvRVkmAOhz+ktFXdISAL21f0NRmFECgMj1NyrAIIBmIErz8A4APZz+qa3/QcAaAF2nFtWpARC6/vYECPWPLcAWgJ0YyBoA8fp/u7OAJQBjE/U/CEgAEOn8x/aJkFD/LgSUAGg9CzGUFABt572YygcAtJuJGMsbAFodAMVc1gCI2QAaGwVsAFiIwaQACNsAGGoELQCoxGjWAIjaANg5DzIAoBCzmQLg9tRiODsAxN0Avl0MlgCIuwGY2ASEDSD2JKAcQDm0DkD7JKAcwETMJwPADR2gOEgCgKgdoIU7AdUAanGRNQCuzNAHgAUAQi8Aur8sJCwAsUdB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"
    );
  }
  let imgdata = upload;
  let extension = await get_extension(imgdata);
  let filename = `file-${uuid.v4()}`;
  let base64Data = await imgdata.replace(/^data:([A-Za-z-+/]+);base64,/, "");
  fs.writeFileSync(
    __dirname + `/../public/${filename}.${extension}`,
    base64Data,
    { encoding: "base64" }
  );
  const file = {
    filename: filename,
    mimetype: extension,
    encoding: "",
    url: `/public/${filename}.${extension}`
  };
  return file;
};

module.exports = {
  get_extension,
  processUpload
};